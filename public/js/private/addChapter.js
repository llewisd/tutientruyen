function setBorderForChapterItem(){document.querySelectorAll(".body_item").forEach(e=>{"0"===e.querySelector(".body_item__error div span:nth-of-type(2)").innerHTML?e.style.border="1px solid var(--opacity-white-color)":e.style.border="1px solid var(--orange-color)"})}function openChapterPopup(){document.querySelector(".add_btn__footer").addEventListener("click",function(e){document.querySelector(".chapter_block").style.display="block"})}function closeChapterPopup(){let t=document.querySelector(".chapter_block");var e=t.querySelector(".chapter_exit div"),r=t.querySelector(".chapter_form__button button:nth-of-type(1)");e.addEventListener("click",function(e){t.style.display="none"}),r.addEventListener("click",function(e){t.style.display="none"})}function handleForCreate(){let y=document.querySelector(".chapter_block");var e=document.querySelector(".add_btn__footer");let h=y.querySelector(".chapter_form");e.addEventListener("click",function(e){y.style.display="block";var t=y.querySelector(".chapter_exit div"),r=y.querySelector(".chapter_form__button button:nth-of-type(1)"),t=(t.addEventListener("click",function(e){y.style.display="none",h.reset(),h.querySelector(".chapter_form__img-list").innerHTML="",h.removeEventListener("submit",m),y.querySelector(".chapter_form__img-input-btn").removeEventListener("click",n),y.querySelector("#chapter_form__input-img").removeEventListener("change",i),y.querySelector(".chapter_form__img-view").removeEventListener("click",p)}),r.addEventListener("click",function(e){y.style.display="none",h.reset(),h.querySelector(".chapter_form__img-list").innerHTML="",h.removeEventListener("submit",m),y.querySelector(".chapter_form__img-input-btn").removeEventListener("click",n),y.querySelector("#chapter_form__input-img").removeEventListener("change",i),y.querySelector(".chapter_form__img-view").removeEventListener("click",p)}),y.querySelector(".chapter_form__img-input-btn"));let o=y.querySelector("#chapter_form__input-img"),a=y.querySelector(".chapter_form__img-list"),c=[];function n(e){o.value="",o.click()}function i(e){var e=e.target.files[0];e&&(e.type.startsWith("image/")?(c.push(e),e=(t=>{let r=document.createElement("img"),e=(r.file=t,r.alt="",new FileReader),o=(e.onload=e=>{r.src=e.target.result},e.readAsDataURL(t),document.createElement("i")),n=(o.classList.add("fa-solid","fa-circle-xmark"),o.style.cursor="pointer",o.onclick=()=>{a.removeChild(n),c=c.filter(e=>e!==t)},document.createElement("div")),i=(n.classList.add("chapter_form__img-item"),n.appendChild(r),document.createElement("div"));return i.appendChild(o),n.appendChild(i),n})(e),a.appendChild(e)):alert("Please select an image file"))}t.addEventListener("click",n),o.addEventListener("change",i);let l=h.querySelector("#chapter_form__input-chuong"),d=y.querySelector(".chapter_form__alert div:nth-of-type(1)"),u=y.querySelector(".chapter_form__alert div:nth-of-type(2)"),s=y.querySelector(".chapter_form__button button:nth-of-type(2)");async function m(e){if(e.preventDefault(),0===document.querySelectorAll(".chapter_form__img-item").length)return alert("Xin vui lòng thêm ảnh");var e=document.querySelector(".body_name").getAttribute("data-truyen-link"),r=document.querySelector(".body_name").getAttribute("data-truyen-id"),t=document.querySelector(".body_name div").textContent,o=h.querySelector("#chapter_form__input-chuong"),n={};n.chapter=o.value;try{var i=await(await fetch(`/addChapter/${e}/${r}/create/folder?name=`+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();if(i.success){let t=new FormData;c.forEach(e=>{t.append("images[]",e)}),"ok"===(await(await fetch(`/addChapter/${e}/${r}/create?folderPath=${i.folderPath}&folderName=${i.folderName}&url=${i.url}&chapter_id=`+i.chapter_id,{method:"POST",body:t})).json()).success?(y.querySelector(".chapter_form__alert div:nth-of-type(3)").style.display="block",setTimeout(()=>{h.removeEventListener("submit",m),window.location.href=window.location.href},1e3)):console.log("addChapter.js - Line 220 : Update image fail")}else console.log("addChapter.js - Line 227 : File uploaded fail !")}catch(e){console.log(e)}}function p(e){var t=y.querySelector(".chapter_form__img-list").querySelectorAll(".chapter_form__img-item img"),r=window.screen.width,o=window.screen.height;let n=window.open("","Image Gallery",`width=600,height=400,top=${o/2-200},left=`+(r/2-300));n.document.write(`
                    <html>
                         <head>
                              <title>Preview chapter</title>
                         </head>
                         <body>

                         </body>
                    </html>
               `);o=n.document.createElement("style");o.innerHTML=`
                    *{
                         margin: 0;
                         padding: 0;
                         box-sizing: border-box;
                    }
                    div {
                         width: 100%;
                    }
                    img {
                         width: 100%;
                         height: 100%;
                         object-fit: cover;
                    }
               `,n.document.head.appendChild(o),t.forEach(e=>{var t=n.document.createElement("img"),e=(t.src=e.src,n.document.createElement("div"));e.appendChild(t),n.document.body.appendChild(e)})}l.addEventListener("input",function(e){var r=l.value.trim();if(1<=r.length)if(isNaN(r)||""===r.trim())d.style.display="block",u.style.display="none",s.disabled=!0;else{var o=document.querySelectorAll(".body_item__chapter");let t=[];o.forEach(e=>{t.push(parseFloat(e.textContent.trim().replace("Chương ","")))}),t.includes(parseFloat(r))?(d.style.display="none",u.style.display="block",s.disabled=!0):(d.style.display="none",u.style.display="none",s.disabled=!1)}else d.style.display="none",u.style.display="none"}),y.querySelector(".chapter_form__button button:nth-of-type(2)").innerHTML="Tạo",h.addEventListener("submit",m),y.querySelector(".chapter_form__img-view").addEventListener("click",p)})}function handleForUpdate(){let b=document.querySelector(".chapter_block");var e=document.querySelector(".body_list").querySelectorAll(".body_item__icon div:nth-of-type(1)");let g=b.querySelector(".chapter_form"),l=document.querySelector(".body_name").getAttribute("data-truyen-link"),S=document.querySelector(".body_name").getAttribute("data-truyen-id");e.forEach(v=>{v.addEventListener("click",async function(t){b.style.display="block";let n=g.querySelector("#chapter_form__input-chuong"),i=b.querySelector(".chapter_form__alert div:nth-of-type(1)"),a=b.querySelector(".chapter_form__alert div:nth-of-type(2)"),c=b.querySelector(".chapter_form__button button:nth-of-type(2)");n.addEventListener("input",function(e){var r=n.value.trim();if(1<=r.length)if(isNaN(r)||""===r.trim())i.style.display="block",a.style.display="none",c.disabled=!0;else{var o=document.querySelectorAll(".body_item__chapter");let t=[];o.forEach(e=>{t.push(parseFloat(e.textContent.trim().replace("Chương ","")))}),t.includes(parseFloat(r))?(i.style.display="none",a.style.display="block",c.disabled=!0):(i.style.display="none",a.style.display="none",c.disabled=!1)}else i.style.display="none",a.style.display="none"});t=t.target.closest(".body_item").getAttribute("data-chapter-id"),t=await(await fetch(`/addChapter/${l}/${S}/update?chapter_id=`+t)).json();if(t.success){b.querySelector("#chapter_form__input-chuong").value=t.data.chuong;var r=window.location.protocol+"//"+window.location.host,o=b.querySelector(".chapter_form__img-input-btn");let e=b.querySelector("#chapter_form__input-img"),i=b.querySelector(".chapter_form__img-list");var d=t.data.truyen.anh_root;let l=[];for(let e of t.data.anh)try{var u=await(await fetch(r+"/"+d+e.path)).blob(),s=new File([u],e.path.split("/").pop(),{type:u.type}),m=(l.push(s),h(s));i.appendChild(m)}catch(e){console.error("Error fetching image:",e)}function p(){e.value="",e.click()}function y(e){var e=e.target.files[0];e&&(e.type.startsWith("image/")?(l.push(e),e=h(e),i.appendChild(e)):alert("Please select an image file"))}function h(t){let r=document.createElement("img");r.file=t,r.alt="";var e=new FileReader,e=(e.onload=e=>{r.src=e.target.result},e.readAsDataURL(t),document.createElement("i"));e.classList.add("fa-solid","fa-circle-xmark"),e.style.cursor="pointer",e.onclick=()=>{i.removeChild(o),l=l.filter(e=>e!==t)};let o=document.createElement("div");o.classList.add("chapter_form__img-item"),o.appendChild(r);var n=document.createElement("div");return n.appendChild(e),o.appendChild(n),o}function _(e){var t=b.querySelector(".chapter_form__img-list").querySelectorAll(".chapter_form__img-item img"),r=window.screen.width,o=window.screen.height;let n=window.open("","Image Gallery",`width=600,height=400,top=${o/2-200},left=`+(r/2-300));n.document.write(`
                              <html>
                                   <head>
                                        <title>Preview chapter</title>
                                   </head>
                                   <body>

                                   </body>
                              </html>
                         `);o=n.document.createElement("style");o.innerHTML=`
                              *{
                                   margin: 0;
                                   padding: 0;
                                   box-sizing: border-box;
                              }
                              div {
                                   width: 100%;
                              }
                              img {
                                   width: 100%;
                                   height: 100%;
                                   object-fit: cover;
                              }
                         `,n.document.head.appendChild(o),t.forEach(e=>{var t=n.document.createElement("img"),e=(t.src=e.src,n.document.createElement("div"));e.appendChild(t),n.document.body.appendChild(e)})}o.addEventListener("click",p),e.addEventListener("change",y),b.querySelector(".chapter_form__button button:nth-of-type(2)").innerHTML="Cập nhật",b.querySelector(".chapter_form__img-view").addEventListener("click",_);t=b.querySelector(".chapter_exit div"),o=b.querySelector(".chapter_form__button button:nth-of-type(1)");async function f(e){if(e.preventDefault(),0===document.querySelectorAll(".chapter_form__img-item").length)return alert("Xin vui lòng thêm ảnh");var e=document.querySelector(".body_name").getAttribute("data-truyen-link"),r=document.querySelector(".body_name").getAttribute("data-truyen-id"),t=document.querySelector(".body_name div").textContent,o=v.closest(".body_item").getAttribute("data-chapter-id"),n=v.closest(".body_item").querySelector(".body_item__chapter").textContent.trim().replace("Chương ",""),i=g.querySelector("#chapter_form__input-chuong"),a={};a.chapter=i.value.trim();try{var c=await(await fetch(`/addChapter/${e}/${r}/update/doc?chapter_id=${o}&truyen_name=${t}&old_chapter=`+n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(c.success){let t=new FormData;l.forEach(e=>{t.append("images[]",e)}),"ok"===(await(await fetch(`/addChapter/${e}/${r}/update/image?folderPath=${c.folderPath}&folderName=${c.folderName}&url=${c.url}&chapter_id=`+c.chapter_id,{method:"POST",body:t})).json()).success?(b.querySelector(".chapter_form__alert div:nth-of-type(3)").style.display="block",setTimeout(()=>{g.removeEventListener("submit",f),window.location.href=window.location.href},1e3)):console.log("addChapter.js - Line 220 : Update image fail")}else console.log("addChapter.js - Line 227 : File uploaded fail !")}catch(e){console.log(e)}}t.addEventListener("click",function(e){b.style.display="none",g.reset(),g.querySelector(".chapter_form__img-list").innerHTML="",g.removeEventListener("submit",f),b.querySelector(".chapter_form__img-input-btn").removeEventListener("click",p),b.querySelector("#chapter_form__input-img").removeEventListener("change",y),b.querySelector(".chapter_form__img-view").removeEventListener("click",_)}),o.addEventListener("click",function(e){b.style.display="none",g.reset(),g.querySelector(".chapter_form__img-list").innerHTML="",g.removeEventListener("submit",f),b.querySelector(".chapter_form__img-input-btn").removeEventListener("click",p),b.querySelector("#chapter_form__input-img").removeEventListener("change",y),b.querySelector(".chapter_form__img-view").removeEventListener("click",_)}),g.addEventListener("submit",f)}})})}function deleteItem(){let l=document.querySelector(".delete_confirm__block");var e=document.querySelectorAll(".body_item__icon div:nth-of-type(2)");let d=l.querySelector(".delete_confirm__select button:nth-of-type(2)");e.forEach(c=>{c.addEventListener("click",function(e){l.style.display="block",l.querySelector(".delete_confirm__select button:nth-child(1)").addEventListener("click",function(e){l.style.display="none",d.removeEventListener("click",a)}),d.addEventListener("click",a);let t=document.querySelector(".body_name").getAttribute("data-truyen-link"),r=document.querySelector(".body_name").getAttribute("data-truyen-id"),o=document.querySelector(".body_name div").textContent,n=c.closest(".body_item").getAttribute("data-chapter-id"),i=c.closest(".body_item__head").querySelector(".body_item__chapter").textContent.trim().replace("Chương ","");async function a(e){try{(await(await fetch(`/addChapter/${t}/${r}/delete/${n}?truyen_name=${o}&chapter=`+i)).json()).success&&(window.location.href=window.location.href)}catch(e){console.log("addChapter.js - Line 646 : "+e)}}})})}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".body_item__error button").forEach(o=>{"0"===o.closest(".body_item__error").querySelector("div span:nth-of-type(2)").innerHTML?(o.disabled=!0,o.style.opacity=.8,o.style.pointerEvents="none"):o.addEventListener("click",async function(e){e.target.closest(".body_item__error").querySelector("div span:nth-of-type(2)").innerHTML="0",o.disabled=!0,o.style.opacity=.8,o.style.pointerEvents="none";e.target.closest(".body_item").style.border="1px solid var(--opacity-white-color)";var t=document.querySelector(".body_name"),r=t.getAttribute("data-truyen-link"),t=t.getAttribute("data-truyen-id"),e=e.target.closest(".body_item").getAttribute("data-chapter-id");await fetch(`/addChapter/${r}/${t}/reportError?chapter_id=`+e).catch(e=>console.log(e))})})}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".body_item__chapter").forEach(e=>{e.addEventListener("click",function(e){e.target.querySelector("a").click()})})}),document.addEventListener("DOMContentLoaded",()=>{setBorderForChapterItem(),handleForCreate(),handleForUpdate(),deleteItem()});